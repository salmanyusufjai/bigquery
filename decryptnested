-- Step 1: Flatten the nested structure and include an identifier for the original rows
WITH flattened_data AS (
  SELECT
    TO_JSON_STRING(t) AS original_json,
    t.*,
    account.latest AS account_latest,
    mainf.decryption_key AS decryption_key,
    OFFSET AS row_index
  FROM
    `your_dataset.your_table` t,
    UNNEST(t.account.latest) AS account_latest WITH OFFSET
),

-- Step 2: Decrypt the fields in rawfields using the decryption key from mainf
decrypted_data AS (
  SELECT
    *,
    ARRAY(
      SELECT AS STRUCT
        key,
        CASE
          WHEN key = 'f1' THEN DECRYPT_STRING(value, decryption_key)
          ELSE value
        END AS value
      FROM UNNEST(REGEXP_EXTRACT_ALL(TO_JSON_STRING(account_latest.rawfields), r'"([^"]+)":\s*"([^"]*)"')) AS rawfields(key, value)
    ) AS decrypted_rawfields
  FROM
    flattened_data
),

-- Step 3: Reassemble the nested structure with decrypted fields
reassembled_data AS (
  SELECT
    original_json,
    ARRAY_AGG(
      STRUCT(
        (SELECT AS STRUCT ARRAY(
          SELECT AS STRUCT key, value
          FROM UNNEST(
            SELECT ARRAY(
              SELECT STRUCT(key, value)
              FROM UNNEST(REGEXP_EXTRACT_ALL(TO_JSON_STRING(decrypted_rawfields), r'"([^"]+)":\s*"([^"]*)"'))
            )
          ) AS r
        )) AS rawfields,
        account_latest.stdfields AS stdfields
      ) ORDER BY row_index
    ) AS latest
  FROM
    decrypted_data
  GROUP BY
    original_json
)

-- Step 4: Select the final structure maintaining the original format
SELECT
  TO_JSON_STRING(
    STRUCT(
      JSON_EXTRACT(original_json, '$.mainf') AS mainf,
      STRUCT(latest AS latest) AS account,
      JSON_EXTRACT(original_json, '$.subject') AS subject,
      -- Include all other objects dynamically
      JSON_EXTRACT(original_json, '$') AS other_objects
    )
  ) AS final_json
FROM
  reassembled_data;
